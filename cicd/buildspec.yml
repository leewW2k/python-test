version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.11
  pre_build:
    commands:
      - pip install --upgrade pip
      - pip install .
      - mkdir test-reports
      - pip install tox
  build:
    commands:
      - tox
  post_build:
    commands:
      - aws codecommit post-comment-for-pull-request --pull-request-id $PULL_REQUEST_ID --repository-name python-fastapi-template --content "Build Failed" --before-commit-id $DESTINATION_COMMIT_ID --after-commit-id $SOURCE_COMMIT_ID --region $AWS_DEFAULT_REGION
      - |
        if [ $CODEBUILD_BUILD_SUCCEEDING -ne 0 ]; then
          PR_STATUS='REVOKE'
        else
          PR_STATUS='APPROVE'
        fi
      - REVISION_ID=$(aws codecommit get-pull-request --pull-request-id $PULL_REQUEST_ID --region $AWS_DEFAULT_REGION | jq -r '.pullRequest.revisionId')
      - aws codecommit update-pull-request-approval-state --pull-request-id $PULL_REQUEST_ID --revision-id $REVISION_ID --approval-state $PR_STATUS --region $AWS_DEFAULT_REGION
      - echo Build completed on `date`

reports:
  coverage_tests:
    files:
      - 'coverage.xml'
    base-directory: 'test-reports'
    file-format: COBERTURAXML
  report:
    files:
      - 'junit.xml'
      - 'report.html'
      - 'assets/*'
    base-directory: 'test-reports'
    discard-paths: yes
    file-format: JunitXml